
URL=https://api.getastra.com/webhooks/integrations/ci-cd
ASTRA_SCAN_TYPE="${ASTRA_SCAN_TYPE:-lightning}"

if [ -n "$ASTRA_CI_BRANCH_NAME" ]; then # OTHER CI
  BRANCH_NAME="$ASTRA_CI_BRANCH_NAME"
else
  if [ -n "$GITHUB_ACTIONS" ]; then # GITHUB
    BRANCH_NAME="${GITHUB_REF}"
  elif [ -n "$GITLAB_CI" ]; then # GITLAB
    BRANCH_NAME="$CI_COMMIT_REF_NAME"
  elif [ -n "$CIRCLECI" ]; then # CIRCLECI
    BRANCH_NAME="$CIRCLE_BRANCH"
  elif [ -n "$BITBUCKET_PIPELINE_UUID" ]; then # BITBUCKET
    if [ -n "$BITBUCKET_BRANCH" ]; then
      BRANCH_NAME="$BITBUCKET_BRANCH"
    elif [ -n "$BITBUCKET_TAG" ]; then
      BRANCH_NAME="$BITBUCKET_TAG"
    else
      echo "â›” Bitbucket: The branch name for the custom pipeline is not recognized."
      exit 1
    fi
  elif [ -n "${JENKINS_URL}" ]; then # JENKINS
    BRANCH_NAME="${BRANCH_NAME}"
  elif [ -n "$SYSTEM_TEAMFOUNDATIONCOLLECTIONURI" ]; then # AZURE
    BRANCH_NAME="${BUILD_SOURCEBRANCH}"
  else
    echo "â›” The branch name retrieval is unsuccessful as the CI/CD platform cannot be determined."
    exit 1
  fi
fi

status_code=$(curl -s -o response.txt -w "%{http_code}" --user-agent "Astra Pentest Trigger Script/1.0" --header "Content-Type: application/json" --request POST --data "{\"accessToken\":\"$ASTRA_ACCESS_TOKEN\",\"projectId\":\"$ASTRA_PROJECT_ID\", \"mode\":\"$ASTRA_AUDIT_MODE\", \"automatedScanType\":\"$ASTRA_SCAN_TYPE\", \"branchName\":\"$BRANCH_NAME\"}" $URL)
if [[ "$status_code" == "200" ]] ; then
  echo "âœ… Astra pentest was successfully started."
  cat response.txt
elif [[ "$status_code" == "422" ]] ; then
  echo "ðŸŸ¡ Cannot start an audit, because an audit might be underway."
  cat response.txt
else
  echo "â›” Failed to start pentest."
  exit 1
fi
