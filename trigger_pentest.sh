#!/bin/bash

URL="https://127.0.0.1:8000/webhooks/integrations/ci-cd"
ASTRA_SCAN_TYPE="${ASTRA_SCAN_TYPE:-lightning}"
ASTRA_JOB_EXIT_STRATEGY="${ASTRA_JOB_EXIT_STRATEGY:-fail_when_vulnerable}"
ASTRA_JOB_EXIT_REFETCH_INTERVAL="${ASTRA_JOB_EXIT_REFETCH_INTERVAL:-120}"
ASTRA_JOB_EXIT_REFETCH_MAX_RETRIES="${ASTRA_JOB_EXIT_REFETCH_MAX_RETRIES:-10}"
ASTRA_JOB_EXIT_CRITERION="severityCount[\\\"high\\\"] > 0 or severityCount[\\\"critical\\\"] > 0"

response=$(curl -s -o response.txt -w "%{http_code}" --user-agent "Astra Pentest Trigger Script/1.0" --header "Content-Type: application/json" --request POST --data "{\"accessToken\":\"$ASTRA_ACCESS_TOKEN\",\"projectId\":\"$ASTRA_PROJECT_ID\", \"mode\":\"$ASTRA_AUDIT_MODE\", \"automatedScanType\":\"$ASTRA_SCAN_TYPE\", \"targetScopeUri\":\"$ASTRA_TARGET_SCOPE_URI\"}" "$URL")
status_code=$(tail -n1 <<< "$response")

if [[ "$status_code" == "200" ]]; then
  echo "âœ… Astra pentest was successfully started."
  audit_id=$(awk '/"auditId"/{print $2}' RS=, FS=: response.txt | tr -d '"' | cut -d'}' -f1)
  vulnerabilities_page_link=$(awk '/"vulnerabilitesPageLink"/{print $2}' RS=, FS=: response.txt | tr -d '"' | cut -d'}' -f1)
  cat response.txt
elif [[ "$status_code" == "422" ]]; then
  echo "ðŸŸ¡ Cannot start an audit, because an audit might be underway."
  cat response.txt
  exit 1
else
  echo "â›” Failed to start pentest. HTTP status code: $status_code"
  exit 1
fi

if [[ "$ASTRA_JOB_EXIT_STRATEGY" == "always_pass" ]]; then
  exit 0
fi

json_data="{\"accessToken\":\"$ASTRA_ACCESS_TOKEN\",\"auditId\":\"$audit_id\",\"jobExitCriterion\":\"$ASTRA_JOB_EXIT_CRITERION\"}"

scan_status_url="https://127.0.0.1:8000/integrations/ci-cd/scan-status"

for ((retry=0; retry<ASTRA_JOB_EXIT_REFETCH_MAX_RETRIES; retry++)); do

  scan_status=$(curl -s -o scan_status_response.txt -w "%{http_code}" \
  --user-agent "Astra Pentest Trigger Script/1.0" \
  --header "Content-Type: application/json" \
  --request POST \
  --data "$json_data" \
  "$scan_status_url")

  if [[ "$scan_status" == "200" ]]; then

    audit_progress=$(awk '/"auditProgress"/{print $2}' RS=, FS=: scan_status_response.txt | tr -d '"' | cut -d'}' -f1)

    if [[ "$audit_progress" == "reported" || "$audit_progress" == "reaudit" || "$audit_progress" == "completed" ]]; then
      echo "âœ… Astra pentest completed successfully."
      exit 0
    fi

    exit_criteria_evaluation=$(awk '/"exitCriteriaEvaluation"/{print $2}' RS=, FS=: scan_status_response.txt | tr -d '"' | cut -d'}' -f1)

    if [[ "$ASTRA_JOB_EXIT_STRATEGY" != "always_pass" ]]; then
      if [[ "$exit_criteria_evaluation" == "true" ]]; then
        echo "â›” Exit criteria evaluation is true. Please check details of vulnerabilities found in the Astra dashboard. Exiting..."
        exit 1
      fi
    fi

    echo "âœ… Scan status retrieved successfully. The scan is underway."
  else
    echo "ðŸŸ¡ Failed to retrieve scan status. Retrying..."
  fi
  sleep "$ASTRA_JOB_EXIT_REFETCH_INTERVAL"
done

if [[ "$ASTRA_JOB_EXIT_STRATEGY" == "always_pass" ]]; then
  echo "âœ… Astra pentest completed successfully."
  exit 0
else
  echo "â›” Pentest failed."
  exit 1
fi
