#!/bin/bash

ASTRA_SCAN_START_URL="https://api.getastra.dev/webhooks/integrations/ci-cd"
ASTRA_SCAN_STATUS_URL="https://api.getastra.dev/webhooks/integrations/ci-cd/scan-status"

ASTRA_SCAN_TYPE="${ASTRA_SCAN_TYPE:-lightning}"
ASTRA_JOB_EXIT_STRATEGY="${ASTRA_JOB_EXIT_STRATEGY:-always_pass}"
ASTRA_JOB_EXIT_REFETCH_INTERVAL="${ASTRA_JOB_EXIT_REFETCH_INTERVAL:-30}"
ASTRA_JOB_EXIT_REFETCH_MAX_RETRIES="${ASTRA_JOB_EXIT_REFETCH_MAX_RETRIES:-10}"
ASTRA_JOB_EXIT_CRITERION="${ASTRA_JOB_EXIT_CRITERION:-severityCount[\\\"high\\\"] > 0 or severityCount[\\\"critical\\\"] > 0}"


echo "ASTRA_ACCESS_TOKEN: $ASTRA_ACCESS_TOKEN"
echo "ASTRA_PROJECT_ID: $ASTRA_PROJECT_ID"
echo "ASTRA_AUDIT_MODE: $ASTRA_AUDIT_MODE"
echo "ASTRA_SCAN_TYPE: $ASTRA_SCAN_TYPE"

response=$(curl -s -o response.txt -w "%{http_code}" --user-agent "Astra Pentest Trigger Script/1.1" --header "Content-Type: application/json" --request POST --data "{\"accessToken\":\"$ASTRA_ACCESS_TOKEN\",\"projectId\":\"$ASTRA_PROJECT_ID\", \"mode\":\"$ASTRA_AUDIT_MODE\", \"automatedScanType\":\"$ASTRA_SCAN_TYPE\", \"targetScopeUri\":\"$ASTRA_TARGET_SCOPE_URI\"}" "$ASTRA_SCAN_START_URL")
status_code=$(tail -n1 <<< "$response")

if [[ "$status_code" == "200" ]]; then
  echo "âœ… The Astra scan has been successfully initiated."
  audit_id=$(awk '/"auditId"/{print $2}' RS=, FS=: response.txt | tr -d '"' | cut -d'}' -f1)
  vulnerabilities_page_link=$(awk '/"vulnerabilitesPageLink"/{print $2}' RS=, FS=: response.txt | tr -d '"' | cut -d'}' -f1)
  echo ""
  echo "Webhook response:"
  cat response.txt
  echo ""
elif [[ "$status_code" == "422" ]]; then
  echo "ðŸŸ¡ Scan initiation failed. Another scan may already be in progress."
  echo ""
  echo "Webhook response:"
  cat response.txt
  exit 1
else
  echo "â›” Scan initiation failed. HTTP status code: $status_code"
  cat response.txt
  exit 1
fi

if [[ "$ASTRA_JOB_EXIT_STRATEGY" == "always_pass" ]]; then
  echo "The scan is currently in progress, and you can review any detected vulnerabilities in the Astra dashboard. As the ASTRA_JOB_EXIT_STRATEGY is set to always_pass, this job will not be blocked."
  exit 0
fi

json_data="{\"accessToken\":\"$ASTRA_ACCESS_TOKEN\",\"auditId\":\"$audit_id\",\"jobExitCriterion\":\"$ASTRA_JOB_EXIT_CRITERION\"}"

for ((retry=0; retry<ASTRA_JOB_EXIT_REFETCH_MAX_RETRIES; retry++)); do

  scan_status=$(curl -s -o scan_status_response.txt -w "%{http_code}" \
  --user-agent "Astra Pentest Trigger Script/1.1" \
  --header "Content-Type: application/json" \
  --request POST \
  --data "$json_data" \
  "$ASTRA_SCAN_STATUS_URL")

  if [[ "$scan_status" == "200" ]]; then

    audit_progress=$(awk '/"auditProgress"/{print $2}' RS=, FS=: scan_status_response.txt | tr -d '"' | cut -d'}' -f1)
    exit_criteria_evaluation=$(awk '/"exitCriteriaEvaluation"/{print $2}' RS=, FS=: scan_status_response.txt | tr -d '"' | cut -d'}' -f1)

    if [[ "$ASTRA_JOB_EXIT_STRATEGY" == "fail_when_vulnerable" ]]; then
      if [[ "$exit_criteria_evaluation" == "true" ]]; then
        echo "â›” Vulnerabilities have been detected according to the criteria defined in ASTRA_JOB_EXIT_CRITERION. Please review the Astra dashboard for a detailed list of vulnerabilities. Exiting the CI/CD job now..."
        exit 1
      fi
    fi

    if [[ "$audit_progress" == "reported" || "$audit_progress" == "reaudit" || "$audit_progress" == "completed" ]]; then
      echo "âœ… The scan has been successfully completed, without matching the exit criteria."
      exit 0
    fi

    echo "ðŸ” The scan is currently in progress, and its status has just been refreshed."
  else
    echo "ðŸŸ¡ Unable to retrieve scan status. Retrying at the next interval..."
  fi
  sleep "$ASTRA_JOB_EXIT_REFETCH_INTERVAL"
done

echo "ðŸ”µ The scan is currently underway, but we are exiting this job as the ASTRA_JOB_EXIT_REFETCH_MAX_RETRIES limit has been reached."
exit 0